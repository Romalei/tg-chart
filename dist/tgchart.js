"use strict";function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t)){for(var i=0,e=new Array(t.length);i<t.length;i++)e[i]=t[i];return e}}function _objectSpread(i){for(var t=1;t<arguments.length;t++){var e=null!=arguments[t]?arguments[t]:{},s=Object.keys(e);"function"==typeof Object.getOwnPropertySymbols&&(s=s.concat(Object.getOwnPropertySymbols(e).filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.forEach(function(t){_defineProperty(i,t,e[t])})}return i}function _defineProperty(t,i,e){return i in t?Object.defineProperty(t,i,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[i]=e,t}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,i){for(var e=0;e<i.length;e++){var s=i[e];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}function _createClass(t,i,e){return i&&_defineProperties(t.prototype,i),e&&_defineProperties(t,e),t}var TgChart=function(){function r(t,i,e){var a=this;_classCallCheck(this,r),"object"===_typeof(i)&&(this.data=i,this.container=t,this.init(),this.config=_objectSpread({},this.config,e),this.canvas=r.dom(this.container,"canvas"),this.buttons=r.dom(this.container,"div","tg-chart-buttons"),this.tooltip=r.dom(this.container,"div","tg-chart-tooltip"),this.ctx=this.canvas.getContext("2d"),this.container.classList.add("tg-chart-wrapper"),Object.keys(this.data.names).forEach(function(i){var t=r.dom(a.buttons,"label");t.className="tg-chart-buttons__item";var e=r.dom(t,"input");e.className="tg-chart-checkbox",e.setAttribute("type","checkbox");var s=r.dom(t,"span");s.className="tg-chart-checkbox-indicator",s.style.setProperty("background-color",a.data.colors[i]);var n=r.dom(t,"span");n.innerText=a.data.names[i],n.className="tg-chart-checkbox-text",r.dom(t,"span").className="tg-chart-checkbox-ripple",e.addEventListener("change",function(t){return a.onBtnClick(t,i)})}),this.columns=this.data.columns.reduce(function(t,i){return t[i[0]]={shown:!0,value:i.slice(1),key:i[0],name:a.data.names[i[0]]},t},{}),this.calculateMaxY(),this.canvas.addEventListener("mousedown",this.onMouseDownOrTouchStart.bind(this)),document.addEventListener("mousemove",this.prepareToMove.bind(this)),this.canvas.addEventListener("touchstart",this.onMouseDownOrTouchStart.bind(this)),document.addEventListener("touchmove",this.prepareToMove.bind(this)),r.refs.push(this),!r.isListenerEnabled&&this.config.responsive&&(window.addEventListener("resize",r.onWindowResize),r.isListenerEnabled=!0),setTimeout(function(){return a.resize(0)},0))}return _createClass(r,[{key:"init",value:function(){this.months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],this.days=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],this.maxY=0,this.config={trackSize:30,minTrackSize:20,lineWidth:3,gridColor:"#A9ABAD",timeLineHeight:80,responsive:!1,height:400,theme:"light"}}},{key:"pointsCount",get:function(){return this.columns.x.value.length}}]),_createClass(r,[{key:"makeViewport",value:function(t,i,e,s){return{x0:t,y0:i,x1:e,y1:s,width:function(){return Math.abs(this.x1-this.x0)},height:function(){return Math.abs(this.y1-this.y0)}}}},{key:"onMouseDownOrTouchStart",value:function(t){this.canvas.contains(t.target)&&(this.isTouched=!0,document.addEventListener("touchend",this.onTouchEndOrMouseUp.bind(this)))}},{key:"onTouchEndOrMouseUp",value:function(t){this.isTouched=!1,this.mode=null,document.removeEventListener("touchend",this.onTouchEndOrMouseUp)}},{key:"prepareToMove",value:function(t){if(this.canvas.contains(t.target)&&this.timeLineVP){var i,e,s,n,a=this.canvas.getBoundingClientRect();t instanceof MouseEvent?(i=1===t.buttons,n=t.pageX-a.left,s=t.offsetY,e=t.movementX):t instanceof TouchEvent&&(i=!!t.touches.length,n=t.touches[0].clientX-a.left,s=t.touches[0].clientY-a.top,e=this.lastTouchX?t.touches[0].pageX-this.lastTouchX:0,this.lastTouchX=t.touches[0].pageX),this.onTouchOrMouseMove(e,i,n,s)}else this.setTooltip(!1)}},{key:"onTouchOrMouseMove",value:function(t,i,e,s){if(!(this.mode||e>=this.timeLineVP.x0&&e<=this.timeLineVP.x1&&s>=this.timeLineVP.y0&&s<=this.timeLineVP.y1))return this.canvas.style.setProperty("cursor","default"),void this.setTooltip(e);if(this.setTooltip(!1),this.mode||(e<=this.trackVP.x0+this.trackVP.resizer?(this.mode="resizing-l",this.canvas.style.setProperty("cursor","ew-resize")):this.trackVP.x1-this.trackVP.resizer<=e?(this.mode="resizing-r",this.canvas.style.setProperty("cursor","ew-resize")):(this.mode="moving",this.canvas.style.setProperty("cursor","pointer"))),!i||!this.isTouched)return this.mode=null,void(this.isTouched=!1);switch(this.mode){case"resizing-l":case"resizing-r":this.resize(t),this.setTrack();break;case"moving":this.move(t)}this.draw()}},{key:"setTooltip",value:function(t){var i=this;if(!1===t)return this.tooltip.classList.remove("tg-chart-tooltip_shown"),void this.draw();var e=this.getItemIndexByX(t+this.chartVP.offset);if(null!=e){var s=Object.keys(this.columns).filter(function(t){return i.columns[t].shown}).map(function(t){return{value:i.columns[t].value[e],name:i.columns[t].name,key:t}});s||this.tooltip.classList.remove("tg-chart-tooltip_shown");var n=s.find(function(t){return!i.isLineCol(t.key)}).value,a=new Date(n),r=s.filter(function(t){return i.isLineCol(t.key)}).map(function(t){return'<div class="tg-chart-tooltip__item" style="color:'.concat(i.data.colors[t.key],'">\n                    <span style="font-weight:bold">').concat(t.value,"</span>\n                    <span>").concat(t.name,"</span>\n                </div>")}).join(""),o=t+10+this.tooltip.clientWidth>this.canvas.width?t-this.tooltip.clientWidth-10:t+10;this.tooltip.classList.add("tg-chart-tooltip_shown"),this.tooltip.style.setProperty("left","".concat(o,"px")),this.tooltip.innerHTML='\n        <span class="tg-chart-tooltip__title">'.concat(this.days[a.getDay()],", ").concat(this.months[a.getMonth()]," ").concat(a.getDate(),"</span>\n\t\t").concat(r);var h=Object.keys(this.columns).filter(function(t){return i.isLineCol(t)&&i.columns[t].shown}).map(function(t){return i.columns[t]});this.draw(),this.ctx.lineWidth=.2,this.ctx.strokeStyle=this.config.gridColor,this.ctx.beginPath(),this.ctx.moveTo(t,this.chartVP.y0),this.ctx.lineTo(t,this.chartVP.y1),this.ctx.stroke(),h.forEach(function(t){i.ctx.beginPath(),i.ctx.strokeStyle=i.data.colors[t.key],i.ctx.lineWidth=i.config.lineWidth,i.ctx.fillStyle="light"===i.config.theme?"#fff":"#242F3E",i.ctx.arc(i.getX(i.columns.x.value[e]),i.getY(t.value[e]),2*i.config.lineWidth,0,2*Math.PI),i.ctx.fill(),i.ctx.stroke()})}else this.setTooltip(!1)}},{key:"onBtnClick",value:function(t,i){this.columns[i].shown=!t.target.checked,this.columns[i].shown||(this.columns[i].disabledaAt=Date.now()),this.calculateMaxY(),this.draw()}},{key:"setViewports",value:function(){this.canvas.width=this.container.clientWidth,this.canvas.height=this.config.height,this.timeLineVP=this.makeViewport(0,this.canvas.height-this.config.timeLineHeight,this.canvas.width,this.canvas.height),this.xAxisVP=this.makeViewport(0,this.timeLineVP.y0-30,this.canvas.width,this.timeLineVP.y0-1),this.chartVP=this.makeViewport(0,30,100*this.canvas.width/this.config.trackSize,this.xAxisVP.y0-1),this.setTrack(),this.move(0),this.draw()}},{key:"setTrack",value:function(){var t=this.trackVP?this.trackVP.x0:0,i=t+this.config.trackSize*this.canvas.width/100;this.trackVP=_objectSpread({},this.makeViewport(t,this.timeLineVP.y0,i,this.timeLineVP.y1),{resizer:10})}},{key:"move",value:function(t){this.trackVP.x1+t>this.canvas.width||this.trackVP.x0+t<0||(this.trackVP.x0+=t,this.trackVP.x1+=t,this.chartVP.offset=100*this.trackVP.x0/this.config.trackSize)}},{key:"resize",value:function(t){var i,e=100*t/this.canvas.width;switch(this.mode){case"resizing-l":var s=this.trackVP.x0+t;(i=this.config.trackSize-e)>=this.config.minTrackSize&&0<=s&&(this.config.trackSize=i,this.trackVP.x0+=t);break;case"resizing-r":var n=this.trackVP.x1+t;(i=this.config.trackSize+e)>=this.config.minTrackSize&&n<=this.canvas.width&&(this.config.trackSize+=e)}this.setViewports()}},{key:"calculateMaxY",value:function(){var s=this;this.targetMaxY=Object.keys(this.columns).reduce(function(t,i){if(!s.isLineCol(i)||!s.columns[i].shown)return t;var e=Math.max.apply(Math,_toConsumableArray(s.columns[i].value));return t<e?e:t},0)}},{key:"draw",value:function(){this.clear(),this.drawMainChart(),this.drawLines(this.timeLineVP,!1,this.targetMaxY),this.drawTrack()}},{key:"drawMainChart",value:function(){this.targetMaxY&&1<Math.abs(this.targetMaxY-this.maxY)?(this.maxY+=(this.targetMaxY-this.maxY)/5,requestAnimationFrame(this.drawMainChart.bind(this))):this.maxY=this.targetMaxY,this.ctx.clearRect(this.chartVP.x0,0,this.canvas.width,this.chartVP.y1+this.xAxisVP.height()),this.drawGrid(),this.drawLines(this.chartVP,!0),this.drawNumbers()}},{key:"drawGrid",value:function(){var t,i=Math.pow(10,this.targetMaxY.toString().length-2);Math.floor(Math.round(this.targetMaxY/5/i)*i);this.ctx.lineWidth=.2,this.ctx.strokeStyle=this.config.gridColor;for(var e=0;e<6;e++)t=this.getY(this.targetMaxY/5*e),this.ctx.beginPath(),this.ctx.moveTo(0,t),this.ctx.lineTo(this.canvas.width,t),this.ctx.stroke()}},{key:"drawNumbers",value:function(){var t,i=Math.pow(10,this.targetMaxY.toString().length-2),e=Math.floor(Math.round(this.targetMaxY/5/i)*i);this.ctx.fillStyle=this.getTextColor(),this.ctx.font="12px sans-serif";for(var s=0;s<6;s++)t=this.getY(this.targetMaxY/5*s),this.ctx.fillText(e*s,5,t-8)}},{key:"drawLines",value:function(){var t,i,e,s,n=this,a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.chartVP,r=1<arguments.length&&void 0!==arguments[1]&&arguments[1],o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:this.maxY;this.ctx.lineWidth=this.config.lineWidth,this.ctx.fillStyle=this.getTextColor(),this.ctx.font="12px sans-serif";for(var h=a.width()/100,c=Math.floor(this.pointsCount/h),l=a.width()/(h+1),u=0,f=0;f<this.pointsCount-1;f+=1)if(t=this.getX(this.columns.x.value[f],a)-(a.offset||0),e=this.getX(this.columns.x.value[f+1],a)-(a.offset||0),!(t<-50||e>this.canvas.width+50)){var d=!0,v=!1,g=void 0;try{for(var m,y=Object.keys(this.columns).filter(function(t){return n.isLineCol(t)&&(n.columns[t].shown||o!==n.targetMaxY)})[Symbol.iterator]();!(d=(m=y.next()).done);d=!0){var x=m.value;i=this.getY(this.columns[x].value[f],o,a),s=this.getY(this.columns[x].value[f+1],o,a),this.ctx.beginPath(),this.ctx.strokeStyle=this.getLineColor(x),this.ctx.moveTo(t,i),this.ctx.lineTo(e,s),this.ctx.stroke()}}catch(t){v=!0,g=t}finally{try{d||null==y.return||y.return()}finally{if(v)throw g}}if(r&&f%c==0){var k=new Date(this.columns.x.value[f]),p="".concat(this.months[k.getMonth()]," ").concat(k.getDate());this.ctx.fillText(p,l*u+++l/6,this.xAxisVP.y0+16)}}}},{key:"drawTrack",value:function(){this.ctx.beginPath(),this.ctx.fillStyle="rgba(0,100,200,.075)",this.ctx.rect(this.timeLineVP.x0,this.trackVP.y0,this.trackVP.x0,this.trackVP.y1),this.ctx.rect(this.trackVP.x1,this.trackVP.y0,this.timeLineVP.x1,this.trackVP.y1),this.ctx.fill(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(0,100,200,.2)",this.ctx.fillStyle="rgba(0,100,200,.2)",this.ctx.rect(this.trackVP.x0,this.trackVP.y0,this.trackVP.resizer,this.trackVP.height()),this.ctx.rect(this.trackVP.x0+this.trackVP.width()-this.trackVP.resizer,this.trackVP.y0,this.trackVP.resizer,this.trackVP.height()),this.ctx.rect(this.trackVP.x0+this.trackVP.resizer,this.trackVP.y0,this.trackVP.width()-this.trackVP.resizer,3),this.ctx.rect(this.trackVP.x0+this.trackVP.resizer,this.trackVP.y1-3,this.trackVP.width()-this.trackVP.resizer,3),this.ctx.fill()}},{key:"clear",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:this.canvas.width,s=3<arguments.length&&void 0!==arguments[3]?arguments[3]:this.canvas.height;this.ctx.clearRect(t,i,e,s)}},{key:"getX",value:function(t){var i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.chartVP;return(t-this.columns.x.value[0])*i.width()/(this.columns.x.value[this.pointsCount-1]-this.columns.x.value[0])}},{key:"getY",value:function(t){var i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.maxY,e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:this.chartVP;0===i&&(i=1);var s=e.height();return s-t*s/i+e.y0}},{key:"getItemIndexByX",value:function(t){var i=100*t/(this.getX(this.columns.x.value[this.pointsCount-1])-this.getX(this.columns.x.value[0]));return Math.floor(i*this.pointsCount/100)}},{key:"isLineCol",value:function(t){return"line"===this.data.types[t]}},{key:"findClosestIndex",value:function(n){var a=-1;return this.columns.x.value.reduce(function(t,i,e){var s=Math.abs(i-n);return s<t?(a=e,s):t},0),a}},{key:"switchTheme",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"light"===this.config.theme?"dark":"light";this.container.classList.remove("tg-chart-wrapper_".concat(this.config.theme)),this.container.classList.add("tg-chart-wrapper_".concat(t)),this.config.theme=t,this.draw()}},{key:"getTextColor",value:function(){return"dark"===this.config.theme?"#fff":"#444"}},{key:"getBgColor",value:function(){return"dark"===this.config.theme?"#242F3E":"#fff"}},{key:"getLineColor",value:function(t){if(this.columns[t].shown)return this.data.colors[t];var i=(200-(Date.now()-this.columns[t].disabledaAt))/100;return r.hexToRgba(this.data.colors[t],i<0?0:i)}}]),r}();TgChart.refs=[],TgChart.isListenerEnabled=!1,TgChart.dom=function(t,i,e){var s=document.createElement(i);return t.appendChild(s),e&&(s.className=e),s},TgChart.hexToRgba=function(t,i){var e=parseInt(t.substring(1,2),16),s=parseInt(t.substring(3,5),16),n=parseInt(t.substring(5,7),16);return"rgba(".concat(e,",").concat(s,",").concat(n,",").concat(i,")")},TgChart.onWindowResize=function(){TgChart.refs.forEach(function(t){return t.setViewports()})};