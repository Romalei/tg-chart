"use strict";function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t)){for(var e=0,i=new Array(t.length);e<t.length;e++)i[e]=t[e];return i}}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{},s=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(s=s.concat(Object.getOwnPropertySymbols(i).filter(function(t){return Object.getOwnPropertyDescriptor(i,t).enumerable}))),s.forEach(function(t){_defineProperty(e,t,i[t])})}return e}function _defineProperty(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),t}var TgChart=function(){function r(t,e,i){var a=this;_classCallCheck(this,r),"object"===_typeof(e)&&(this.data=e,this.container=t,this.init(),this.config=_objectSpread({},this.config,i),this.canvas=r.dom(this.container,"canvas"),this.buttons=r.dom(this.container,"div","tg-chart-buttons"),this.tooltip=r.dom(this.container,"div","tg-chart-tooltip"),this.ctx=this.canvas.getContext("2d"),this.container.classList.add("tg-chart-wrapper"),Object.keys(this.data.names).forEach(function(e){var t=r.dom(a.buttons,"label");t.className="tg-chart-buttons__item";var i=r.dom(t,"input");i.className="tg-chart-checkbox",i.setAttribute("type","checkbox");var s=r.dom(t,"span");s.className="tg-chart-checkbox-indicator",s.style.setProperty("background-color",a.data.colors[e]);var n=r.dom(t,"span");n.innerText=a.data.names[e],n.className="tg-chart-checkbox-text",r.dom(t,"span").className="tg-chart-checkbox-ripple",i.addEventListener("change",function(t){return a.onBtnClick(t,e)})}),this.columns=this.data.columns.reduce(function(t,e){return t[e[0]]={shown:!0,value:e.slice(1),key:e[0],name:a.data.names[e[0]]},t},{}),this.calculateMaxY(),this.canvas.addEventListener("mousedown",this.onMouseDownOrTouchStart.bind(this)),document.addEventListener("mousemove",this.prepareToMove.bind(this)),this.canvas.addEventListener("touchstart",this.onMouseDownOrTouchStart.bind(this)),document.addEventListener("touchmove",this.prepareToMove.bind(this)),r.refs.push(this),!r.isListenerEnabled&&this.config.responsive&&(window.addEventListener("resize",r.onWindowResize),r.isListenerEnabled=!0),setTimeout(function(){return a.resize(0)},0))}return _createClass(r,[{key:"init",value:function(){this.months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],this.days=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],this.maxY=0,this.config={trackSize:30,minTrackSize:20,lineWidth:3,gridColor:"#A9ABAD",timeLineHeight:80,responsive:!1,height:400,theme:"light"}}},{key:"pointsCount",get:function(){return this.columns.x.value.length}}]),_createClass(r,[{key:"makeViewport",value:function(t,e,i,s){return{x0:t,y0:e,x1:i,y1:s,width:function(){return Math.abs(this.x1-this.x0)},height:function(){return Math.abs(this.y1-this.y0)}}}},{key:"onMouseDownOrTouchStart",value:function(t){this.canvas.contains(t.target)&&(this.isTouched=!0,document.addEventListener("touchend",this.onTouchEndOrMouseUp.bind(this)))}},{key:"onTouchEndOrMouseUp",value:function(t){this.isTouched=!1,this.mode=null,document.removeEventListener("touchend",this.onTouchEndOrMouseUp)}},{key:"prepareToMove",value:function(t){if(this.canvas.contains(t.target)&&this.timeLineVP){var e,i,s,n,a=this.canvas.getBoundingClientRect();t instanceof MouseEvent?(e=1===t.buttons,n=t.pageX-a.left,s=t.offsetY,i=t.movementX):t instanceof TouchEvent&&(e=!!t.touches.length,n=t.touches[0].clientX-a.left,s=t.touches[0].clientY-a.top,i=this.lastTouchX?t.touches[0].pageX-this.lastTouchX:0,this.lastTouchX=t.touches[0].pageX),this.onTouchOrMouseMove(i,e,n,s)}else this.setTooltip(!1)}},{key:"onTouchOrMouseMove",value:function(t,e,i,s){if(!(this.mode||i>=this.timeLineVP.x0&&i<=this.timeLineVP.x1&&s>=this.timeLineVP.y0&&s<=this.timeLineVP.y1))return this.canvas.style.setProperty("cursor","default"),void this.setTooltip(i);if(this.setTooltip(!1),this.mode||(i<=this.trackVP.x0+this.trackVP.resizer?(this.mode="resizing-l",this.canvas.style.setProperty("cursor","ew-resize")):this.trackVP.x1-this.trackVP.resizer<=i?(this.mode="resizing-r",this.canvas.style.setProperty("cursor","ew-resize")):(this.mode="moving",this.canvas.style.setProperty("cursor","pointer"))),!e||!this.isTouched)return this.mode=null,void(this.isTouched=!1);switch(this.mode){case"resizing-l":case"resizing-r":this.resize(t),this.setTrack();break;case"moving":this.move(t)}this.draw()}},{key:"setTooltip",value:function(t){var e=this;if(!1!==t){var i=this.getItemIndexByX(t+this.chartVP.offset);if(null!=i){var s=Object.keys(this.columns).filter(function(t){return e.columns[t].shown}).map(function(t){return{value:e.columns[t].value[i],name:e.columns[t].name,key:t}});s||this.tooltip.classList.remove("tg-chart-tooltip_shown");var n=s.find(function(t){return!e.isLineCol(t.key)}).value,a=new Date(n),r=s.filter(function(t){return e.isLineCol(t.key)}).map(function(t){return'<div class="tg-chart-tooltip__item" style="color:'.concat(e.data.colors[t.key],'">\n                    <span style="font-weight:bold">').concat(t.value,"</span>\n                    <span>").concat(t.name,"</span>\n                </div>")}).join(""),o=t+10+this.tooltip.clientWidth>this.canvas.width?t-this.tooltip.clientWidth-10:t+10;this.tooltip.classList.add("tg-chart-tooltip_shown"),this.tooltip.style.setProperty("left","".concat(o,"px")),this.tooltip.innerHTML='\n        <span class="tg-chart-tooltip__title">'.concat(this.days[a.getDay()],", ").concat(this.months[a.getMonth()]," ").concat(a.getDate(),"</span>\n\t\t").concat(r);var h=Object.keys(this.columns).filter(function(t){return e.isLineCol(t)&&e.columns[t].shown}).map(function(t){return e.columns[t]});this.draw(),this.ctx.lineWidth=.2,this.ctx.strokeStyle=this.config.gridColor,this.ctx.beginPath(),this.ctx.moveTo(t,this.chartVP.y0),this.ctx.lineTo(t,this.chartVP.y1),this.ctx.stroke(),h.forEach(function(t){e.ctx.beginPath(),e.ctx.strokeStyle=e.data.colors[t.key],e.ctx.lineWidth=e.config.lineWidth,e.ctx.fillStyle="light"===e.config.theme?"#fff":"#242F3E",e.ctx.arc(e.getX(e.columns.x.value[i]),e.getY(t.value[i]),2*e.config.lineWidth,0,2*Math.PI),e.ctx.fill(),e.ctx.stroke()})}else this.setTooltip(!1)}else this.tooltip.classList.remove("tg-chart-tooltip_shown")}},{key:"onBtnClick",value:function(t,e){this.columns[e].shown=!t.target.checked,this.columns[e].shown||(this.columns[e].disabledaAt=Date.now()),this.calculateMaxY(),this.draw()}},{key:"setViewports",value:function(){this.canvas.width=this.container.clientWidth,this.canvas.height=this.config.height,this.timeLineVP=this.makeViewport(0,this.canvas.height-this.config.timeLineHeight,this.canvas.width,this.canvas.height),this.xAxisVP=this.makeViewport(0,this.timeLineVP.y0-30,this.canvas.width,this.timeLineVP.y0-1),this.chartVP=this.makeViewport(0,30,100*this.canvas.width/this.config.trackSize,this.xAxisVP.y0-1),this.setTrack(),this.move(0),this.draw()}},{key:"setTrack",value:function(){var t=this.trackVP?this.trackVP.x0:0,e=t+this.config.trackSize*this.canvas.width/100;this.trackVP=_objectSpread({},this.makeViewport(t,this.timeLineVP.y0,e,this.timeLineVP.y1),{resizer:10})}},{key:"move",value:function(t){this.trackVP.x1+t>this.canvas.width||this.trackVP.x0+t<0||(this.trackVP.x0+=t,this.trackVP.x1+=t,this.chartVP.offset=100*this.trackVP.x0/this.config.trackSize)}},{key:"resize",value:function(t){var e,i=100*t/this.canvas.width;switch(this.mode){case"resizing-l":var s=this.trackVP.x0+t;(e=this.config.trackSize-i)>=this.config.minTrackSize&&0<=s&&(this.config.trackSize=e,this.trackVP.x0+=t);break;case"resizing-r":var n=this.trackVP.x1+t;(e=this.config.trackSize+i)>=this.config.minTrackSize&&n<=this.canvas.width&&(this.config.trackSize+=i)}this.setViewports()}},{key:"calculateMaxY",value:function(){var s=this;this.targetMaxY=Object.keys(this.columns).reduce(function(t,e){if(!s.isLineCol(e)||!s.columns[e].shown)return t;var i=Math.max.apply(Math,_toConsumableArray(s.columns[e].value));return t<i?i:t},0)}},{key:"draw",value:function(){this.clear(),this.drawMainChart(),this.drawLines(this.timeLineVP,!1,this.targetMaxY),this.drawTrack()}},{key:"drawMainChart",value:function(){this.targetMaxY&&1<Math.abs(this.targetMaxY-this.maxY)?(this.maxY+=(this.targetMaxY-this.maxY)/5,requestAnimationFrame(this.drawMainChart.bind(this))):this.maxY=this.targetMaxY,this.ctx.clearRect(this.chartVP.x0,0,this.canvas.width,this.chartVP.y1+this.xAxisVP.height()),this.drawGrid(),this.drawLines(this.chartVP,!0),this.drawNumbers()}},{key:"drawGrid",value:function(){var t,e=Math.pow(10,this.targetMaxY.toString().length-2);Math.floor(Math.round(this.targetMaxY/5/e)*e);this.ctx.lineWidth=.2,this.ctx.strokeStyle=this.config.gridColor;for(var i=0;i<6;i++)t=this.getY(this.targetMaxY/5*i),this.ctx.beginPath(),this.ctx.moveTo(0,t),this.ctx.lineTo(this.canvas.width,t),this.ctx.stroke()}},{key:"drawNumbers",value:function(){var t,e=Math.pow(10,this.targetMaxY.toString().length-2),i=Math.floor(Math.round(this.targetMaxY/5/e)*e);this.ctx.fillStyle=this.getTextColor(),this.ctx.font="12px sans-serif";for(var s=0;s<6;s++)t=this.getY(this.targetMaxY/5*s),this.ctx.fillText(i*s,5,t-8)}},{key:"drawLines",value:function(){var t,e,i,s,n=this,a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.chartVP,r=1<arguments.length&&void 0!==arguments[1]&&arguments[1],o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:this.maxY;this.ctx.lineWidth=this.config.lineWidth,this.ctx.fillStyle=this.getTextColor(),this.ctx.font="12px sans-serif";for(var h=a.width()/100,c=Math.floor(this.pointsCount/h),l=a.width()/(h+1),u=0,f=0;f<this.pointsCount-1;f+=1)if(t=this.getX(this.columns.x.value[f],a)-(a.offset||0),i=this.getX(this.columns.x.value[f+1],a)-(a.offset||0),!(t<-50||i>this.canvas.width+50)){var d=!0,v=!1,g=void 0;try{for(var m,y=Object.keys(this.columns).filter(function(t){return n.isLineCol(t)&&(n.columns[t].shown||o!==n.targetMaxY)})[Symbol.iterator]();!(d=(m=y.next()).done);d=!0){var x=m.value;e=this.getY(this.columns[x].value[f],o,a),s=this.getY(this.columns[x].value[f+1],o,a),this.ctx.beginPath(),this.ctx.strokeStyle=this.getLineColor(x),this.ctx.moveTo(t,e),this.ctx.lineTo(i,s),this.ctx.stroke()}}catch(t){v=!0,g=t}finally{try{d||null==y.return||y.return()}finally{if(v)throw g}}if(r&&f%c==0){var k=new Date(this.columns.x.value[f]),p="".concat(this.months[k.getMonth()]," ").concat(k.getDate());this.ctx.fillText(p,l*u+++l/6,this.xAxisVP.y0+16)}}}},{key:"drawTrack",value:function(){this.ctx.beginPath(),this.ctx.fillStyle="rgba(0,100,200,.075)",this.ctx.rect(this.timeLineVP.x0,this.trackVP.y0,this.trackVP.x0,this.trackVP.y1),this.ctx.rect(this.trackVP.x1,this.trackVP.y0,this.timeLineVP.x1,this.trackVP.y1),this.ctx.fill(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(0,100,200,.2)",this.ctx.fillStyle="rgba(0,100,200,.2)",this.ctx.rect(this.trackVP.x0,this.trackVP.y0,this.trackVP.resizer,this.trackVP.height()),this.ctx.rect(this.trackVP.x0+this.trackVP.width()-this.trackVP.resizer,this.trackVP.y0,this.trackVP.resizer,this.trackVP.height()),this.ctx.rect(this.trackVP.x0+this.trackVP.resizer,this.trackVP.y0,this.trackVP.width()-this.trackVP.resizer,3),this.ctx.rect(this.trackVP.x0+this.trackVP.resizer,this.trackVP.y1-3,this.trackVP.width()-this.trackVP.resizer,3),this.ctx.fill()}},{key:"clear",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:this.canvas.width,s=3<arguments.length&&void 0!==arguments[3]?arguments[3]:this.canvas.height;this.ctx.clearRect(t,e,i,s)}},{key:"getX",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.chartVP;return(t-this.columns.x.value[0])*e.width()/(this.columns.x.value[this.pointsCount-1]-this.columns.x.value[0])}},{key:"getY",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.maxY,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:this.chartVP;0===e&&(e=1);var s=i.height();return s-t*s/e+i.y0}},{key:"getItemIndexByX",value:function(t){var e=100*t/(this.getX(this.columns.x.value[this.pointsCount-1])-this.getX(this.columns.x.value[0]));return Math.floor(e*this.pointsCount/100)}},{key:"isLineCol",value:function(t){return"line"===this.data.types[t]}},{key:"findClosestIndex",value:function(n){var a=-1;return this.columns.x.value.reduce(function(t,e,i){var s=Math.abs(e-n);return s<t?(a=i,s):t},0),a}},{key:"switchTheme",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"light"===this.config.theme?"dark":"light";this.container.classList.remove("tg-chart-wrapper_".concat(this.config.theme)),this.container.classList.add("tg-chart-wrapper_".concat(t)),this.config.theme=t,this.draw()}},{key:"getTextColor",value:function(){return"dark"===this.config.theme?"#fff":"#444"}},{key:"getBgColor",value:function(){return"dark"===this.config.theme?"#242F3E":"#fff"}},{key:"getLineColor",value:function(t){if(this.columns[t].shown)return this.data.colors[t];var e=(200-(Date.now()-this.columns[t].disabledaAt))/100;return r.hexToRgba(this.data.colors[t],e<0?0:e)}}]),r}();TgChart.refs=[],TgChart.isListenerEnabled=!1,TgChart.dom=function(t,e,i){var s=document.createElement(e);return t.appendChild(s),i&&(s.className=i),s},TgChart.hexToRgba=function(t,e){var i=parseInt(t.substring(1,2),16),s=parseInt(t.substring(3,5),16),n=parseInt(t.substring(5,7),16);return"rgba(".concat(i,",").concat(s,",").concat(n,",").concat(e,")")},TgChart.onWindowResize=function(){TgChart.refs.forEach(function(t){return t.setViewports()})};